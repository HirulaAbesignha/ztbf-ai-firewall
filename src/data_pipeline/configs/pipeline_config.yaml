# ZTBF Data Pipeline Configuration

# ===== INGESTION CONFIGURATION =====
ingestion:
  api:
    host: "0.0.0.0"
    port: 8000
    workers: 4
    reload: false  # Set to true for development
    
    # API Keys (In production: load from secrets manager)
    api_keys:
      - "test_key"
      - "dev_key"
      - "prod_key"
    
    # Rate limiting
    rate_limit_per_minute: 10000
    rate_limit_per_hour: 500000
    
    # Request limits
    max_batch_size: 1000
    max_request_size_mb: 10
  
  queue:
    # Memory queue settings
    max_memory_size: 100000  # events
    
    # Disk overflow settings
    disk_buffer_path: "data/queue_overflow.db"
    overflow_strategy: "disk"  # "disk" or "drop"
    
    # Performance tuning
    enable_compression: false
    enable_deduplication: false


# ===== PROCESSING CONFIGURATION =====
processing:
  # Worker pool
  num_workers: 8
  worker_queue_size: 1000
  
  # Batch processing
  batch_size: 100
  batch_timeout_seconds: 5
  max_batch_age_seconds: 30
  
  # Error handling
  max_retries: 3
  retry_delay_seconds: 1
  retry_backoff_multiplier: 2
  
  # Normalization
  normalization:
    strict_validation: true
    drop_invalid_events: false
    log_validation_errors: true
  
  # Enrichment
  enrichment:
    enable_geoip: true
    enable_entity_metadata: true
    enable_device_fingerprint: true
    enable_resource_classification: true
    
    # GeoIP settings
    geoip:
      provider: "mock"  # "mock", "maxmind", "ipapi"
      database_path: "data/GeoLite2-City.mmdb"
      cache_size: 10000
      cache_ttl_seconds: 3600
    
    # Entity metadata caching
    entity_cache:
      enabled: true
      max_size: 50000
      ttl_seconds: 3600
      refresh_interval_seconds: 1800


# ===== STORAGE CONFIGURATION =====
storage:
  # Backend selection
  backend: "local"  # "local", "minio", "s3"
  
  # Local filesystem storage
  local:
    base_path: "data/events"
    enable_compression: true
    compression_type: "snappy"  # "snappy", "gzip", "lz4"
  
  # MinIO storage (for local MVP)
  minio:
    endpoint_url: "http://localhost:9000"
    access_key: "minioadmin"
    secret_key: "minioadmin"
    bucket_name: "ztbf-events"
    region: "us-east-1"
    secure: false  # Use HTTPS
  
  # AWS S3 storage (for production)
  s3:
    bucket_name: "ztbf-events-prod"
    region: "us-east-1"
    # Credentials from AWS SDK/env variables
  
  # Storage tiers
  tiers:
    hot:
      retention_days: 7
      compression: "snappy"
      partition_by: ["date", "hour", "source_system"]
    
    warm:
      retention_days: 30
      compression: "snappy"
      partition_by: ["date", "source_system"]
    
    cold:
      retention_days: 90
      compression: "gzip"
      partition_by: ["date"]
  
  # Lifecycle management
  lifecycle:
    enabled: true
    run_interval_hours: 24
    run_at_hour: 2  # 2 AM


# ===== LOGGING CONFIGURATION =====
logging:
  level: "INFO"  # DEBUG, INFO, WARNING, ERROR, CRITICAL
  format: "json"  # "text" or "json"
  
  # File logging
  file:
    enabled: true
    path: "logs/pipeline.log"
    max_size_mb: 100
    backup_count: 10
    rotation: "time"  # "time" or "size"
  
  # Console logging
  console:
    enabled: true
    colored: true
  
  # Log levels by component
  components:
    api: "INFO"
    processor: "INFO"
    normalizer: "INFO"
    enricher: "INFO"
    storage: "INFO"
    queue: "WARNING"


# ===== MONITORING CONFIGURATION =====
monitoring:
  # Metrics
  metrics:
    enabled: true
    export_interval_seconds: 60
    
    prometheus:
      enabled: false
      port: 9090
      path: "/metrics"
  
  # Health checks
  health:
    enabled: true
    check_interval_seconds: 30
    
    checks:
      - queue_size
      - disk_space
      - storage_connectivity
      - processing_rate
  
  # Alerting (future)
  alerts:
    enabled: false
    channels: []


# ===== PERFORMANCE TUNING =====
performance:
  # Async settings
  async:
    event_loop: "uvloop"  # "asyncio", "uvloop"
    max_concurrent_tasks: 1000
  
  # Memory management
  memory:
    max_memory_usage_mb: 4096
    gc_interval_seconds: 300
  
  # CPU optimization
  cpu:
    process_affinity: []  # CPU cores to use (empty = all)
    thread_pool_size: 4


# ===== SECURITY CONFIGURATION =====
security:
  # Encryption
  encryption:
    at_rest: false  # Encrypt stored data
    in_transit: true  # Use TLS
  
  # Data anonymization
  anonymization:
    enabled: true
    anonymize_ip: true  # Mask last octet
    hash_entity_ids: true
    hash_device_ids: true
  
  # PII handling
  pii:
    scrub_payloads: true
    allowed_fields: []  # Fields that can contain PII


# ===== FEATURE FLAGS =====
features:
  enable_synthetic_generator: true
  enable_batch_ingestion: true
  enable_streaming_ingestion: true
  enable_file_ingestion: true
  enable_webhook_ingestion: true


# ===== DEVELOPMENT SETTINGS =====
development:
  debug_mode: false
  hot_reload: false
  mock_external_services: true
  disable_auth: false
  verbose_logging: false